# Production RAG System Architecture
# Render: d2 rag-production.d2 rag-production.svg --theme 200

direction: right

title: |md
  # Production RAG System
  Enterprise-grade retrieval augmented generation
| {
  near: top-center
  shape: text
  style.font-size: 24
}

# Data Ingestion Layer
ingestion: Data Ingestion {
  style.fill: "#f8fafc"
  style.stroke: "#94a3b8"
  style.border-radius: 8

  docs: ðŸ“„ Documents {
    shape: cylinder
    style.fill: "#e2e8f0"
    style.stroke: "#334155"
  }

  loader: ðŸ“¥ Document Loader {
    style.fill: "#334155"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  chunker: âœ‚ï¸ Semantic Chunker {
    style.fill: "#334155"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  docs -> loader: "PDF, DOCX, MD"
  loader -> chunker: "Raw Text"
}

# Embedding Layer
embedding: Embedding Generation {
  style.fill: "#f0fdfa"
  style.stroke: "#14b8a6"
  style.border-radius: 8

  model: ðŸ§  Embedding Model {
    style.fill: "#06b6d4"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  cache: ðŸ’¾ Embedding Cache {
    shape: cylinder
    style.fill: "#e0f2fe"
    style.stroke: "#0284c7"
  }
}

# Vector Storage
storage: Vector Database {
  style.fill: "#faf5ff"
  style.stroke: "#a855f7"
  style.border-radius: 8

  vectordb: ðŸ—„ï¸ Pinecone / pgvector {
    shape: cylinder
    style.fill: "#9333ea"
    style.font-color: "#ffffff"
  }

  index: ðŸ”¢ HNSW Index {
    style.fill: "#c4b5fd"
    style.border-radius: 8
  }
}

# Query Pipeline
query: Query Pipeline {
  style.fill: "#f0fdf4"
  style.stroke: "#22c55e"
  style.border-radius: 8

  input: ðŸ‘¤ User Query {
    style.fill: "#06b6d4"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  embed_q: ðŸ”„ Query Embedding {
    style.fill: "#334155"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  search: ðŸ” Semantic Search {
    style.fill: "#334155"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  rerank: âš¡ Cross-Encoder Rerank {
    style.fill: "#9333ea"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }
}

# Generation
generation: Response Generation {
  style.fill: "#fffbeb"
  style.stroke: "#f59e0b"
  style.border-radius: 8

  context: ðŸ“‹ Context Assembly {
    style.fill: "#334155"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  llm: ðŸ¤– Claude / GPT-4 {
    style.fill: "#06b6d4"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }

  response: ðŸ’¬ Response + Citations {
    style.fill: "#06b6d4"
    style.font-color: "#ffffff"
    style.border-radius: 8
  }
}

# Monitoring
monitoring: Observability {
  style.fill: "#fef3c7"
  style.stroke: "#f59e0b"
  style.border-radius: 8

  langfuse: ðŸ“Š LangFuse Traces {
    style.fill: "#fbbf24"
    style.border-radius: 8
  }

  evals: ðŸ“ˆ Evaluation Metrics {
    style.fill: "#fbbf24"
    style.border-radius: 8
  }
}

# Connections - Ingestion Flow
ingestion.chunker -> embedding.model: "Chunks" {
  style.stroke: "#334155"
  style.stroke-width: 2
}
embedding.model -> embedding.cache: "Cache"
embedding.model -> storage.vectordb: "Vectors" {
  style.stroke: "#9333ea"
  style.stroke-width: 2
}
storage.vectordb -> storage.index

# Connections - Query Flow
query.input -> query.embed_q: "Text"
query.embed_q -> embedding.model: "Embed" {
  style.stroke-dash: 3
}
query.embed_q -> query.search: "Query Vector"
query.search -> storage.vectordb: "ANN Search" {
  style.stroke: "#9333ea"
  style.stroke-width: 2
}
storage.vectordb -> query.rerank: "Top-K Results"
query.rerank -> generation.context: "Reranked Docs" {
  style.stroke: "#22c55e"
  style.stroke-width: 2
}
generation.context -> generation.llm: "Prompt + Context"
generation.llm -> generation.response: "Answer" {
  style.stroke: "#06b6d4"
  style.stroke-width: 2
}

# Monitoring connections
generation.llm -> monitoring.langfuse: "Traces" {
  style.stroke-dash: 5
  style.stroke: "#f59e0b"
}
generation.response -> monitoring.evals: "Metrics" {
  style.stroke-dash: 5
  style.stroke: "#f59e0b"
}
